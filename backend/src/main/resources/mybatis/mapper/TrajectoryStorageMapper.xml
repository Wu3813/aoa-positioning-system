<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wu.monitor.mapper.TrajectoryStorageMapper">
    
    <!-- 批量插入轨迹记录 -->
    <insert id="insertBatch" parameterType="list">
        INSERT INTO trajectory_data 
        (device_id, map_id, timestamp, x, y)
        VALUES
        <foreach collection="records" item="record" separator=",">
            (#{record.deviceId}, #{record.mapId}, #{record.timestamp},
             #{record.x}, #{record.y})
        </foreach>
    </insert>
    
    <!-- 查询设备历史轨迹 - 直接使用前端传入的时间，不做任何时区转换处理 -->
    <select id="selectByDeviceId" resultType="com.wu.monitor.model.TrajectoryRecord">
        SELECT 
            id, 
            device_id as deviceId, 
            map_id as mapId, 
            timestamp, 
            x, 
            y
        FROM trajectory_data
        WHERE device_id = #{deviceId}
        <if test="mapId != null">
            AND map_id = #{mapId}
        </if>
        <if test="startTime != null">
            AND timestamp >= #{startTime}
        </if>
        <if test="endTime != null">
            AND timestamp &lt;= #{endTime}
        </if>
        ORDER BY timestamp ASC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 创建分区（按天） -->
    <update id="createPartition" statementType="CALLABLE">
        {call CreateTrajectoryPartition(#{date})}
    </update>
    
    <!-- 删除分区（按天） -->
    <update id="dropPartition" statementType="CALLABLE">
        {call DropTrajectoryPartition(#{date})}
    </update>
    
    <!-- 获取最旧的分区日期 -->
    <select id="getOldestPartitionDate" resultType="java.time.LocalDate">
        SELECT 
            STR_TO_DATE(SUBSTRING(partition_name, 2), '%Y%m%d') as partition_date
        FROM information_schema.partitions 
        WHERE table_schema = DATABASE() 
          AND table_name = 'trajectory_data'
          AND partition_name != 'p_future'
        ORDER BY partition_name ASC
        LIMIT 1
    </select>
    
    <!-- 检查分区是否存在 -->
    <select id="checkPartitionExists" resultType="int">
        SELECT COUNT(*) 
        FROM information_schema.partitions 
        WHERE table_schema = DATABASE() 
          AND table_name = 'trajectory_data' 
          AND partition_name = #{partitionName}
    </select>
    
    <!-- 获取数据库磁盘使用信息 -->
    <select id="getDiskSpaceInfo" resultType="map">
        SELECT 
            ROUND(SUM(data_length + index_length) / 1024 / 1024 / 1024, 2) as used_gb,
            ROUND(SUM(data_free) / 1024 / 1024 / 1024, 2) as free_gb
        FROM information_schema.TABLES
        WHERE table_schema = DATABASE()
    </select>
    
</mapper> 