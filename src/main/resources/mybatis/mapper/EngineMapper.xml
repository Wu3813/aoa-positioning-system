<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wu.monitor.mapper.EngineMapper">
    <!-- 结果映射 -->
    <resultMap id="engineMap" type="com.wu.monitor.model.Engine">
        <id property="id" column="id"/>
        <result property="code" column="code"/>
        <result property="name" column="name"/>
        <result property="managementUrl" column="management_url"/>
        <result property="dataUrl" column="data_url"/>
        <result property="mapId" column="map_id"/>
        <result property="mapName" column="map_name"/>
        <result property="status" column="status"/>
        <result property="version" column="version"/>
        <result property="lastCommunication" column="last_communication"/>
        <result property="createTime" column="create_time"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        e.id, e.code, e.name, e.management_url, e.data_url, e.map_id, e.status, e.version,
        e.last_communication, e.create_time, e.remark, m.name as map_name
    </sql>

    <!-- 查询所有引擎 -->
    <select id="findAll" resultMap="engineMap">
        SELECT <include refid="Base_Column_List"/>
        FROM engine e
        LEFT JOIN map m ON e.map_id = m.id
        <where>
            <if test="code != null and code != ''">
                AND e.code LIKE CONCAT('%', #{code}, '%')
            </if>
            <if test="name != null and name != ''">
                AND e.name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="status != null">
                AND e.status = #{status}
            </if>
        </where>
        ORDER BY e.create_time ASC
    </select>

    <!-- 根据ID查询引擎 -->
    <select id="findById" resultMap="engineMap">
        SELECT <include refid="Base_Column_List"/>
        FROM engine e
        LEFT JOIN map m ON e.map_id = m.id
        WHERE e.id = #{id}
    </select>

    <!-- 根据编号查询引擎 -->
    <select id="findByCode" resultMap="engineMap">
        SELECT <include refid="Base_Column_List"/>
        FROM engine e
        LEFT JOIN map m ON e.map_id = m.id
        WHERE e.code = #{code}
    </select>

    <!-- 插入引擎 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO engine (
            code, name, management_url, data_url, map_id, status, version,
            last_communication, create_time, remark
        ) VALUES (
            #{code}, #{name}, #{managementUrl}, #{dataUrl}, #{mapId}, #{status}, #{version},
            #{lastCommunication}, #{createTime}, #{remark}
        )
    </insert>

    <!-- 更新引擎 -->
    <update id="update">
        UPDATE engine
        <set>
            <if test="code != null">code = #{code},</if>
            <if test="name != null">name = #{name},</if>
            <if test="managementUrl != null">management_url = #{managementUrl},</if>
            <if test="dataUrl != null">data_url = #{dataUrl},</if>
            <if test="mapId != null">map_id = #{mapId},</if>
            <if test="status != null">status = #{status},</if>
            <if test="version != null">version = #{version},</if>
            <if test="lastCommunication != null">last_communication = #{lastCommunication},</if>
            <if test="remark != null">remark = #{remark}</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 删除引擎 -->
    <delete id="deleteById">
        DELETE FROM engine WHERE id = #{id}
    </delete>

    <!-- 批量删除引擎 -->
    <delete id="batchDelete">
        DELETE FROM engine WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 根据地图ID查询引擎 -->
    <select id="findByMapId" resultMap="engineMap">
        SELECT <include refid="Base_Column_List"/>
        FROM engine e
        LEFT JOIN map m ON e.map_id = m.id
        WHERE e.map_id = #{mapId}
        ORDER BY e.create_time ASC
    </select>

    <!-- 更新引擎状态 -->
    <update id="updateStatus">
        UPDATE engine
        SET status = #{status},
            last_communication = NOW()
        WHERE id = #{id}
    </update>
</mapper> 